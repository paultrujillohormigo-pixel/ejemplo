{% extends "base.html" %}
{% block content %}

<h2 style="margin-bottom:20px;">ðŸ“Š Dashboard â€“ SeÃ±or Chilaquil</h2>

<!-- ================= KPI CARDS ================= -->
<div class="kpis">
    <div class="card">
        <h4>Total Ingresos</h4>
        <h2>{{ total_ingresos | money }}</h2>
    </div>
    <div class="card">
        <h4>Total Costos</h4>
        <h2>{{ total_costos | money }}</h2>
    </div>
    <div class="card">
        <h4>Utilidad</h4>
        <h2>{{ utilidad | money }}</h2>
    </div>
    <div class="card">
        <h4>Margen</h4>
        <h2>{{ margen }}%</h2>
    </div>
</div>

<hr>
<form method="get" action="/dashboard" style="margin-bottom:20px;">
    <label style="font-weight:bold;">Filtrar por mes:</label>
    <input type="month" name="mes" value="{{ mes or '' }}">
    <button type="submit">Aplicar</button>
    <a href="/dashboard" style="margin-left:10px;">Limpiar</a>
</form>
<!-- ================= GRAFICAS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="graficas-container">

    <!-- GRAFICA LINEA -->
    <div class="grafica-box">
        <h3>Ingresos vs Costos (por mes)</h3>
        <div class="canvas-wrapper">
            <canvas id="graficaIngresos"></canvas>
        </div>
    </div>

    <!-- GRAFICA PASTEL -->
    <div class="grafica-box">
        <h3>Costos por tipo</h3>
        <div class="canvas-wrapper">
            <canvas id="graficaCostos"></canvas>
        </div>
    </div>

</div>

<hr>

<!-- ================= TOP PRODUCTOS ================= -->
<h3>Top productos vendidos</h3>
<table>
    <tr>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Ingreso</th>
    </tr>
    {% for p in top_productos %}
    <tr>
        <td>{{ p.nombre }}</td>
        <td>{{ p.cantidad }}</td>
        <td>{{ p.ingreso | money }}</td>
    </tr>
    {% endfor %}
</table>

<!-- ================= JAVASCRIPT ================= -->
<script>
    const labelsMeses = {{ ingresos | map(attribute="mes") | list | tojson }};
    const dataIngresos = {{ ingresos | map(attribute="total") | list | tojson }};
    const dataCostos = {{ costos | map(attribute="costo") | list | tojson }};

    new Chart(document.getElementById('graficaIngresos'), {
        type: 'bar',
        data: {
            labels: labelsMeses,
            datasets: [
                {
                    label: 'Ingresos',
                    data: dataIngresos,
                    borderColor: 'rgb(0,200,0)',
                    backgroundColor: 'rgba(0,200,0,0.2)',
                    tension: 0.3
                },
                {
                    label: 'Costos',
                    data: dataCostos,
                    borderColor: 'rgb(220,0,0)',
                    backgroundColor: 'rgba(220,0,0,0.2)',
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    const labelsTipos = {{ costos_tipo | map(attribute="tipo_costo") | list | tojson }};
    const dataTipos = {{ costos_tipo | map(attribute="total") | list | tojson }};

    new Chart(document.getElementById('graficaCostos'), {
        type: 'doughnut',
        data: {
            labels: labelsTipos,
            datasets: [{
                data: dataTipos,
                backgroundColor: [
                    '#ff6384',
                    '#36a2eb',
                    '#ffce56',
                    '#4bc0c0',
                    '#9966ff',
                    '#ff9f40'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
</script>

<!-- ================= ESTILOS ================= -->
<style>
/* KPIs */
.kpis{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:15px;
    margin-bottom:30px;
}

.card{
    background:#111;
    color:#fff;
    padding:20px;
    border-radius:10px;
    text-align:center;
}

/* Graficas */
.graficas-container{
    display:grid;
    grid-template-columns: 2fr 1fr;
    gap:25px;
    margin:30px 0;
    width:100%;
    max-width:100%;
    box-sizing:border-box;
}

.grafica-box{
    background:#111;
    padding:20px;
    border-radius:12px;
    width:100%;
    max-width:100%;
    overflow:hidden;
}

.grafica-box h3{
    text-align:center;
    margin-bottom:10px;
    color:white;
}

/* Control REAL del tamaÃ±o */
.canvas-wrapper{
    position:relative;
    width:100%;
    height:260px;
}

/* Tabla */
table{
    width:100%;
    margin-top:15px;
    border-collapse: collapse;
}

th{
    background:#222;
    color:white;
}

td, th{
    padding:8px;
    border:1px solid #333;
}

/* Responsive */
@media (max-width: 900px) {
    .graficas-container{
        grid-template-columns: 1fr;
    }
    .kpis{
        grid-template-columns: 1fr 1fr;
    }
}
</style>

{% endblock %}
